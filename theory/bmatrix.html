
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>DIPY &#8212; Python  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/css/dipy.css?v=80c83778" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'theory/bmatrix';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />

  <meta name="keywords" content="DIPY, dMRI, DTI, DSI, diffusion MRI, Tensor,
  neuroimaging, python, neuroscience, Eleftherios, Garyfallidis, tractography,
  streamlines, fiber tracking">




  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    <p class="title logo__title">Python  documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../documentation.html">
                        Documentation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../stateoftheart.html">
                        A quick overview of features
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../documentation.html">
                        Documentation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../stateoftheart.html">
                        A quick overview of features
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">DIPY</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
<section id="the-b-matrix-and-siemens-dicom">
<h1>The B matrix and Siemens DICOM<a class="headerlink" href="#the-b-matrix-and-siemens-dicom" title="Link to this heading">#</a></h1>
<p>This is a short note to explain the nature of the <code class="docutils literal notranslate"><span class="pre">B_matrix</span></code> found in the
Siemens private (CSA) fields of the DICOM headers of a diffusion-weighted
acquisition.  We try to explain the relationship between the <code class="docutils literal notranslate"><span class="pre">B_matrix</span></code> and
the <em>b value</em> and the <em>gradient vector</em>.  The acquisition is made with a planned
(requested) b value - say <span class="math notranslate nohighlight">\(b_{req} = 1000\)</span>, and with a requested gradient
direction <span class="math notranslate nohighlight">\(\mathbf{g}_{req} = [g_x, g_y, g_z]\)</span> (supposedly a unit vector).</p>
<p>Note that here we’re using <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> in the sense of an approximation
to a vector in <span class="math notranslate nohighlight">\(q\)</span> space.  Other people use <span class="math notranslate nohighlight">\(\mathbf{b}\)</span> for the same
concept, but we’ve chosen <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> to make the exposition clearer.</p>
<p>For some purposes, we want the q vector <span class="math notranslate nohighlight">\(\mathbf{q}_{actual}\)</span> which is
equal to <span class="math notranslate nohighlight">\(b_{actual} . \mathbf{g}_{actual}\)</span>. We need to be aware that
<span class="math notranslate nohighlight">\(b_{actual}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{g}_{actual}\)</span> may be different from the
<span class="math notranslate nohighlight">\(b_{req}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{g}_{req}\)</span>!  Though the Stejskal and Tanner
formula is available for the classic PGSE sequence, a different sequence
may be used (e.g. TRSE on Siemens Trio), and anyway, the ramps up and
down on the gradient field will not be rectangular. The Siemens scanner
software calculates the effective directional diffusion weighting of the
acquisition based on the temporal profile of the applied gradient
vector field. These are in the form of the 6 <code class="docutils literal notranslate"><span class="pre">B_matrix</span></code> values
<span class="math notranslate nohighlight">\([b_{xx}, b_{xy}, b_{xz}, b_{yy}, b_{yz}, b_{zz}]\)</span>.</p>
<p>In this form they are suitable for use in a least squares estimation of
the diffusion tensor via the equations across the set of acquisitions:</p>
<div class="math notranslate nohighlight">
\[\log(A(\mathbf{q})/A(0)) = -(b_{xx}D_{xx} + 2b_{xy}D_{xy} + 2b_{xz}D_{xz} + \
   b_{yy}D_{yy} + 2b_{yz}D_{yz} + b_{zz}D_{zz})\]</div>
<p>The gradient field typically stays in the one gradient direction, in
this case the relationship between <span class="math notranslate nohighlight">\(\mathbf{q}\)</span> and the <span class="math notranslate nohighlight">\(b_{ij}\)</span> is as
follows. If we fill out the symmetric B-matrix as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{B} = \begin{pmatrix}
              b_{xx} &amp; b_{yx} &amp; b_{yz}\\
              b_{xy} &amp; b_{yy} &amp; b_{xz}\\
              b_{xz} &amp; b_{yz} &amp; b_{zz}
              \end{pmatrix}\end{split}\]</div>
<p>then <span class="math notranslate nohighlight">\(\mathbf{B}\)</span> is equal to the rank 1 tensor
<span class="math notranslate nohighlight">\(b\mathbf{g}\mathbf{g}^T\)</span>. One of the ways to recover <span class="math notranslate nohighlight">\(b\)</span> and <span class="math notranslate nohighlight">\(\mathbf{g}\)</span>,
and hence <span class="math notranslate nohighlight">\(\mathbf{q}\)</span>, from
<span class="math notranslate nohighlight">\(\mathbf{B}\)</span> is to do a singular value decomposition of <span class="math notranslate nohighlight">\(\mathbf{B}:
\mathbf{B} = \lambda_1\mathbf{v}_1\mathbf{v}_1^T +
\lambda_2\mathbf{v}_2\mathbf{v}_2^T +
\lambda_3\mathbf{v}_3\mathbf{v}_3^T\)</span>, where only one of the <span class="math notranslate nohighlight">\(\lambda_i\)</span>,
say <span class="math notranslate nohighlight">\(\lambda_1\)</span>, is effectively non-zero. Then <span class="math notranslate nohighlight">\(b = \lambda_1\)</span>, <span class="math notranslate nohighlight">\(\mathbf{g} =
\pm\mathbf{v}_1,\)</span> and <span class="math notranslate nohighlight">\(\mathbf{q} =
\pm\lambda_1\mathbf{v}_1.\)</span> The choice of sign is arbitrary
(essentially we have a choice between two possible square roots of the
rank 1 tensor <span class="math notranslate nohighlight">\(\mathbf{B}\)</span>). Once we have <span class="math notranslate nohighlight">\(\mathbf{q}_{actual}\)</span> we can
calculate <span class="math notranslate nohighlight">\(b_{actual} = |\mathbf{q}_{actual}|\)</span> and <span class="math notranslate nohighlight">\(\mathbf{g}_{actual}
= \mathbf{q}_{actual} / b_{actual}\)</span>. Various software packages
(e.g. FSL’s DFT-DTIFIT) expect to get 3 × N and 1 × N arrays of
<span class="math notranslate nohighlight">\(\mathbf{g}_{actual}\)</span> and <span class="math notranslate nohighlight">\(b_{actual}\)</span> values as their inputs.</p>
</section>

<div class="section ablog__blog_comments">
  
  
</div>

                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>